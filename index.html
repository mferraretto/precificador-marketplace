<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Precificador Shopee e Mercado Livre</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <meta name="theme-color" content="#dc3545" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  <style>
  :root {
    --bg: #f9f9f9;
    --text: #212529;
    --card: #ffffff;
    --accent: #dc3545;
    --accent-hover: #c82333;
    --border: #dee2e6;
  }

  body.dark {
    --bg: #1e1e1e;
    --text: #f8f9fa;
    --card: #2c2c2c;
    --accent: #ff4d4f;
    --accent-hover: #e03131;
    --border: #444;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: "Segoe UI", sans-serif;
    padding: 20px;
    max-width: 1000px;
    margin: auto;
    background-color: var(--bg);
    color: var(--text);
    transition: background 0.3s, color 0.3s;
  }

  h1 {
    text-align: center;
    color: var(--accent);
    margin-bottom: 25px;
  }

  label {
    font-weight: 600;
    margin-top: 12px;
    display: block;
  }

  input {
    margin-top: 5px;
    padding: 10px;
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    color: var(--text);
  }

  fieldset {
    margin-top: 20px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background-color: var(--card);
    padding: 20px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);
  }

  legend {
    font-weight: bold;
    color: var(--accent);
    padding: 0 10px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
  }

  .top-actions {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .top-actions button {
    margin-left: auto;
  }

  button {
    margin: 10px 10px 10px 0;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    background-color: var(--accent);
    color: white;
    transition: background-color 0.2s;
  }

  button:hover {
    background-color: var(--accent-hover);
  }

  .btn-excluir {
    background-color: #6c757d;
  }

  .btn-excluir:hover {
    background-color: #495057;
  }

  #filtro {
    margin-top: 15px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    width: 100%;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    background-color: var(--card);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  th, td {
    border: 1px solid var(--border);
    padding: 12px;
    text-align: left;
  }

  th {
    background-color: var(--accent);
    color: #fff;
    font-weight: bold;
  }

  @media (max-width: 600px) {
    th, td {
      font-size: 14px;
    }

    .top-actions {
      flex-direction: column;
      align-items: flex-start;
    }

    button {
      width: 100%;
    }
  }
</style>
</head>
<body>
  <div id="telaLogin" style="text-align:center; margin-top: 100px;">
  <h2>Bem-vindo!</h2>
  <p>Digite seu nome para continuar:</p>
  <input id="nomeUsuario" placeholder="Seu nome..." />
  <button onclick="fazerLogin()"><i class="fas fa-sign-in-alt"></i> Entrar</button>
</div>
  <div class="top-actions">
    <h1>Precificador Shopee e Mercado Livre</h1>
    <button onclick="alternarModo()"><i class="fas fa-adjust"></i> Modo Claro/Escuro</button>
    <button onclick="fazerLogout()" id="btnLogout" style="display:none"><i class="fas fa-sign-out-alt"></i> Sair</button>
  </div>

  <label>Filtro por nome do produto:</label>
  <input type="text" id="filtro" oninput="filtrarTabela()" placeholder="Digite para filtrar...">

  <label>Nome do Produto:</label>
  <input type="text" id="nomeProduto" />

  <label>Custo do Produto (R$):</label>
  <input type="text" id="custoProduto" />

  <fieldset>
    <legend>Shopee</legend>
    <div class="form-grid">
      <div>
        <label>Comissão (%):</label>
        <input type="text" id="comissaoShopee" />
      </div>
      <div>
        <label>Taxa Fixa (R$):</label>
        <input type="text" id="taxaShopee" />
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Mercado Livre</legend>
    <div class="form-grid">
      <div>
        <label>Comissão (%):</label>
        <input type="text" id="comissaoML" />
      </div>
      <div>
        <label>Taxa Fixa (R$):</label>
        <input type="text" id="taxaML" />
      </div>
    </div>
  </fieldset>

  <button onclick="calcularSalvar()"><i class="fas fa-save"></i> Calcular e Salvar</button>
  <button onclick="exportarCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
  <button onclick="exportarPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>

  <table id="tabelaResultados">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Custo (R$)</th>
        <th>Shopee (R$)</th>
        <th>Lucro Shopee</th>
        <th>Mercado Livre (R$)</th>
        <th>Lucro ML</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<script>
  const tabela = document.querySelector("#tabelaResultados tbody");
  let produtos = [];
  let editandoIndex = -1;

  function sanitize(valor) {
    return parseFloat(String(valor).replace(',', '.')) || 0;
  }

  function salvarTaxas() {
    localStorage.setItem("taxas_config", JSON.stringify({
      comissaoShopee: document.getElementById("comissaoShopee").value,
      taxaShopee: document.getElementById("taxaShopee").value,
      comissaoML: document.getElementById("comissaoML").value,
      taxaML: document.getElementById("taxaML").value
    }));
  }

  function restaurarTaxas() {
    const config = JSON.parse(localStorage.getItem("taxas_config") || "{}");
    if (config.comissaoShopee) document.getElementById("comissaoShopee").value = config.comissaoShopee;
    if (config.taxaShopee) document.getElementById("taxaShopee").value = config.taxaShopee;
    if (config.comissaoML) document.getElementById("comissaoML").value = config.comissaoML;
    if (config.taxaML) document.getElementById("taxaML").value = config.taxaML;
  }

  function calcularSalvar() {
    const nome = document.getElementById("nomeProduto").value.trim();
    const custo = sanitize(document.getElementById("custoProduto").value);
    const taxaShopee = sanitize(document.getElementById("taxaShopee").value);
    const comissaoShopee = sanitize(document.getElementById("comissaoShopee").value) / 100;
    const taxaML = sanitize(document.getElementById("taxaML").value);
    const comissaoML = sanitize(document.getElementById("comissaoML").value) / 100;

    if (!nome || custo <= 0) {
      alert("Preencha corretamente os campos obrigatórios.");
      return;
    }

    salvarTaxas();

    const precoShopee = ((custo + taxaShopee) / (1 - comissaoShopee)).toFixed(2);
    const precoML = ((custo + taxaML) / (1 - comissaoML)).toFixed(2);
    const lucroShopee = (precoShopee - custo).toFixed(2);
    const lucroML = (precoML - custo).toFixed(2);

    const produto = { nome, custo: custo.toFixed(2), precoShopee, precoML, lucroShopee, lucroML };

    if (editandoIndex >= 0) {
      produtos[editandoIndex] = produto;
      editandoIndex = -1;
    } else {
      produtos.push(produto);
    }

    localStorage.setItem("produtos_precificados", JSON.stringify(produtos));
    document.getElementById("nomeProduto").value = "";
    document.getElementById("custoProduto").value = "";
    let usuarioAtual = localStorage.getItem("usuario_nome");

function fazerLogin() {
  const nome = document.getElementById("nomeUsuario").value.trim();
  if (!nome) return alert("Digite um nome válido.");
  usuarioAtual = nome;
  localStorage.setItem("usuario_nome", nome);
  document.getElementById("telaLogin").style.display = "none";
  [...document.body.children].forEach(el => {
    if (el.id !== "telaLogin") el.style.display = "";
  });
  carregarProdutos();
  renderizarTabela();
  document.getElementById("btnLogout").style.display = "";
}
function fazerLogout() {
  localStorage.removeItem("usuario_nome");
  location.reload();
}

function carregarProdutos() {
  produtos = JSON.parse(localStorage.getItem(`produtos_${usuarioAtual}`) || "[]");
}

function salvarProdutos() {
  localStorage.setItem(`produtos_${usuarioAtual}`, JSON.stringify(produtos));
}
    renderizarTabela();
  }

  function excluirProduto(index) {
    if (confirm("Deseja realmente excluir este produto?")) {
      produtos.splice(index, 1);
salvarProdutos();
      renderizarTabela();
    }
  }

  function editarProduto(index) {
    const p = produtos[index];
    document.getElementById("nomeProduto").value = p.nome;
    document.getElementById("custoProduto").value = p.custo;
    editandoIndex = index;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function renderizarTabela() {
    tabela.innerHTML = "";
    produtos.forEach((p, index) => {
      tabela.innerHTML += `
        <tr>
          <td>${p.nome}</td>
          <td>R$ ${p.custo}</td>
          <td>R$ ${p.precoShopee}</td>
          <td>R$ ${p.lucroShopee}</td>
          <td>R$ ${p.precoML}</td>
          <td>R$ ${p.lucroML}</td>
          <td>
            <button onclick="editarProduto(${index})"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn-excluir" onclick="excluirProduto(${index})"><i class="fas fa-trash-alt"></i> Excluir</button>
          </td>
        </tr>`;
    });
  }

  function exportarCSV() {
    let csv = "Produto,Custo,Shopee,Lucro Shopee,ML,Lucro ML\n";
    produtos.forEach(p => {
      csv += `${p.nome},${p.custo},${p.precoShopee},${p.lucroShopee},${p.precoML},${p.lucroML}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "produtos_precificados.csv";
    link.click();
  }

  function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const margem = 10;
  const larguraTotal = 190;
  const colunas = ["Produto", "Custo", "Shopee", "Lucro S.", "ML", "Lucro ML"];
  const larguraColuna = larguraTotal / colunas.length;
  let y = 20;

  // Título
  doc.setFontSize(16);
  doc.setTextColor(220, 53, 69);
  doc.text("Relatório de Produtos Precificados", margem, 15);

  // Cabeçalho
  doc.setFillColor(220, 53, 69);
  doc.setTextColor(255, 255, 255);
  colunas.forEach((titulo, i) => {
    doc.rect(margem + i * larguraColuna, y, larguraColuna, 10, "F");
    doc.text(titulo, margem + i * larguraColuna + 2, y + 7);
  });

  y += 10;

  // Conteúdo
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);

  produtos.forEach((p, index) => {
    const dados = [
      p.nome.length > 15 ? p.nome.substring(0, 15) + "…" : p.nome,
      `R$ ${p.custo}`,
      `R$ ${p.precoShopee}`,
      `R$ ${p.lucroShopee}`,
      `R$ ${p.precoML}`,
      `R$ ${p.lucroML}`
    ];

    dados.forEach((dado, i) => {
      doc.text(dado, margem + i * larguraColuna + 2, y + 6);
    });

    y += 10;
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
  });

  doc.save("produtos_precificados.pdf");
}

  function alternarModo() {
    document.body.classList.toggle("dark");
    localStorage.setItem("modo_escuro", document.body.classList.contains("dark") ? "1" : "0");
  }

  function restaurarModo() {
    const escuro = localStorage.getItem("modo_escuro");
    if (escuro === "1") {
      document.body.classList.add("dark");
    }
  }

  function filtrarTabela() {
    const filtro = document.getElementById("filtro").value.toLowerCase();
    const linhas = tabela.querySelectorAll("tr");
    linhas.forEach(linha => {
      const nome = linha.children[0]?.textContent?.toLowerCase() || "";
      linha.style.display = nome.includes(filtro) ? "" : "none";
    });
  }

restaurarModo();
restaurarTaxas();

if (!usuarioAtual) {
  document.getElementById("telaLogin").style.display = "block";
  [...document.body.children].forEach(el => {
    if (el.id !== "telaLogin") el.style.display = "none";
  });
} else {
  document.getElementById("btnLogout").style.display = "";
  document.getElementById("telaLogin").style.display = "none";
  [...document.body.children].forEach(el => {
    if (el.id !== "telaLogin") el.style.display = "";
  });
  carregarProdutos();
  renderizarTabela();
}
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('Service Worker registrado'))
      .catch(err => console.error('Erro no SW:', err));
  }
</script>
</body>
</html>
